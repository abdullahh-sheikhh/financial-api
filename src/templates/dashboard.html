<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Gainers</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f1119;
            color: #e1e1e1;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #2a2d3a;
            flex-wrap: wrap;
            gap: 10px;
        }
        h1 { font-size: 1.5rem; color: #fff; }
        .controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        input[type="text"], select, button {
            background: #232636;
            color: white;
            border: 1px solid #3a3d4a;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
        }
        input[type="text"] { width: 280px; }
        input[type="text"]:focus { outline: none; border-color: #3b82f6; }
        select, button { cursor: pointer; }
        select:hover, button:hover { border-color: #3b82f6; }
        button.primary { background: #3b82f6; border-color: #3b82f6; }
        button.primary:hover { background: #2563eb; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .status { font-size: 12px; color: #9ca3af; min-width: 100px; }
        .status.loading { color: #fbbf24; }
        .status.error { color: #ef4444; }
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 13px;
            color: #9ca3af;
            cursor: pointer;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background: #1a1d29;
            border-radius: 8px;
            overflow: hidden;
        }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #2a2d3a; }
        th {
            background: #232636;
            font-weight: 600;
            color: #9ca3af;
            font-size: 12px;
            text-transform: uppercase;
        }
        tr:hover { background: #232636; }
        .ticker { font-weight: 600; color: #fff; }
        .name { color: #9ca3af; font-size: 13px; max-width: 200px; overflow: hidden; text-overflow: ellipsis; }
        .price, .volume { font-family: monospace; }
        .volume { color: #9ca3af; }
        .positive { color: #22c55e; font-weight: 600; }
        .negative { color: #ef4444; font-weight: 600; }
        .rank { color: #6b7280; }
        .loading-row td { text-align: center; color: #9ca3af; padding: 40px; }
        .msg { text-align: center; padding: 40px; color: #9ca3af; }
        .msg.error { color: #ef4444; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Top Gainers</h1>
            <div class="controls">
                <input type="text" id="apiKey" placeholder="Enter Polygon API Key">
                <select id="timeframe">
                    <option value="1">1 min</option>
                    <option value="3">3 min</option>
                    <option value="5">5 min</option>
                    <option value="10" selected>10 min</option>
                </select>
                <label class="checkbox-label">
                    <input type="checkbox" id="autoRefresh"> Auto Refresh
                </label>
                <button onclick="refresh()" id="refreshBtn" class="primary">Load</button>
                <button onclick="exportCsv()">Export to CSV</button>
                <span class="status" id="status"></span>
            </div>
        </header>
        <table>
            <thead>
                <tr>
                    <th>#</th>
                    <th>Ticker</th>
                    <th>Name</th>
                    <th>Current Price</th>
                    <th>Avg Price</th>
                    <th>Volume</th>
                    <th id="gainHeader">10min %</th>
                    <th>Day %</th>
                </tr>
            </thead>
            <tbody id="tbody">
                <tr><td colspan="8" class="msg">Enter your Polygon API key and click Load</td></tr>
            </tbody>
        </table>
    </div>
    <script>
        let data = [];
        let autoInterval = null;

        // Load saved API key
        const savedKey = localStorage.getItem('polygon_api_key');
        if (savedKey) document.getElementById('apiKey').value = savedKey;

        async function refresh() {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey) {
                document.getElementById('tbody').innerHTML =
                    '<tr><td colspan="8" class="msg error">Please enter API key</td></tr>';
                return;
            }

            // Save API key
            localStorage.setItem('polygon_api_key', apiKey);

            const btn = document.getElementById('refreshBtn');
            const status = document.getElementById('status');
            const tbody = document.getElementById('tbody');
            const timeframe = document.getElementById('timeframe').value;

            document.getElementById('gainHeader').textContent = `${timeframe}min %`;

            btn.disabled = true;
            status.textContent = 'Loading...';
            status.className = 'status loading';

            try {
                const res = await fetch(`/gainers?minutes=${timeframe}&apiKey=${encodeURIComponent(apiKey)}`);
                if (!res.ok) throw new Error(`API error: ${res.status}`);
                data = await res.json();

                if (!data.gainers?.length) {
                    tbody.innerHTML = '<tr><td colspan="8" class="msg">No data returned</td></tr>';
                } else {
                    tbody.innerHTML = data.gainers.map((g, i) => `
                        <tr>
                            <td class="rank">${i + 1}</td>
                            <td class="ticker">${g.ticker}</td>
                            <td class="name">${g.name}</td>
                            <td class="price">$${g.current_price.toFixed(2)}</td>
                            <td class="price">$${g.avg_price.toFixed(2)}</td>
                            <td class="volume">${g.volume.toLocaleString()}</td>
                            <td class="${g.gain_window >= 0 ? 'positive' : 'negative'}">
                                ${g.gain_window >= 0 ? '+' : ''}${g.gain_window.toFixed(2)}%
                            </td>
                            <td class="${g.gain_day >= 0 ? 'positive' : 'negative'}">
                                ${g.gain_day >= 0 ? '+' : ''}${g.gain_day.toFixed(2)}%
                            </td>
                        </tr>
                    `).join('');
                }

                status.textContent = new Date(data.time).toLocaleTimeString();
                status.className = 'status';
            } catch (err) {
                tbody.innerHTML = `<tr><td colspan="8" class="msg error">${err.message}</td></tr>`;
                status.textContent = 'Error';
                status.className = 'status error';
            }
            btn.disabled = false;
        }

        function exportCsv() {
            if (!data.gainers?.length) return;
            const rows = [
                'Rank,Ticker,Name,Current Price,Avg Price,Volume,Window%,Day%',
                ...data.gainers.map((g, i) => `${i+1},${g.ticker},"${g.name}",${g.current_price},${g.avg_price},${g.volume},${g.gain_window},${g.gain_day}`)
            ];
            const blob = new Blob([rows.join('\n')], { type: 'text/csv' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `report_${new Date().toISOString().slice(0,10)}.csv`;
            a.click();
        }

        document.getElementById('autoRefresh').addEventListener('change', (e) => {
            if (e.target.checked) autoInterval = setInterval(refresh, 60000);
            else clearInterval(autoInterval);
        });

        document.getElementById('apiKey').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') refresh();
        });
    </script>
</body>
</html>
